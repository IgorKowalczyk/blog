{% unless page.comments == false %}
{% capture post_slug %}{{ page.slug | slugify: "latin" }}{% endcapture %}
<form method="post" action="{{ site.comments-post }}" class="commentform" data-action="{{ site.comments-post }}">
<h3 class="new-comment">Napisz komentarz:</h3>
<input name="fields[slug]" type="hidden" value="{{ post_slug }}" class="commentform-input commentform-input-slug">
<input name="options[slug]" type="hidden" value="{{ post_slug }}" class="commentform-input commentform-input-optionsslug">
<input name="options[redirect]" type="hidden" value="{{ page.slug }}">
<fieldset>
<label for="name">Imię (Wyświetlane, wymagane)
<input name="fields[name]" type="text" id="name" placeholder="Jan Kowalski" required title="To pole jest wymagane" class="commentform-input commentform-input-name">
</label>
</fieldset>
<fieldset>
<label for="email">E-mail (Ukryty, wymagany)
<input name="fields[email]" id="email" type="email" placeholder="jan@kowalski.com" required title="To pole jest wymagane" maxlenght="50" spellcheck="false" class="commentform-input commentform-input-email">
</label>
</fieldset>
<fieldset>
<label for="message">Wiadomość (Wyświetlana, wymagana)
<textarea name="fields[message]" type="text" id="message" placeholder="Twoja wiadomość" title="To pole jest wymagane" maxlenght="200" required autocomplete="off"  class="commentform-input commentform-input-message"></textarea>
</label>
</fieldset>
<!-- Honeypot -->
<fieldset class="hp">
<label for="hp">Zabezpieczenie (Nie wypełniaj!)
<input name="fields[hp]" type="text" id="hp" placeholder="Nie wypełniaj tego! To jest zabezpieczenie przeciwko botom">
</label>
</fieldset>
<!-- /Honeypot -->
<p>Markdown jest obsługiwany.</p>
<p>Komentarze pojawią się po zaakceptowaniu przez moderatora.</p>
<button class="submit" type="submit">Wyślij komentarz</button>
</form>
{% else %}
<div class="notice">
<h4>Dodawanie komentarzy zostało zablokowane.</h4>
</div>
{% endunless %}


<!-- ======================== -->
<!-- Not working code, to fix -->
<!-- ======================== -->
<div class="commentform-sendfailed">
Wiadomość nie mogła zostać wysłana, proszę spróbować później.
</div>
<div class="commentform-sendsucceeded">
Dziękuje, twój komentarz został poprawnie wysłany!
</div>
<div class="commentform-errormessages"></div>
<script>
const commentForm = document.querySelector('.commentForm');
const commentFormInputs = document.querySelectorAll('.commentForm-input');
const slugInput = document.querySelector('.commentForm-input-slug');
const optionsSlugInput = document.querySelector('.commentForm-input-optionsSlug');
const nameInput = document.querySelector('.commentForm-input-name');
const emailInput = document.querySelector('.commentForm-input-email');
const messageInput = document.querySelector('.commentForm-input-message');
const errorMessagesDiv = document.querySelector('.commentForm-errorMessages');
const sendFailedDiv = document.querySelector('.commentForm-sendFailed');
const sendSucceededDiv = document.querySelector('.commentForm-sendSucceeded');

function post(url, data, callback, errorCallback) {
  const xhr = new XMLHttpRequest();
  xhr.open('POST', url);
  xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
  xhr.onload = function() {
    if (xhr.status === 200) {
      callback(xhr.responseText);
    } else if (xhr.status !== 200) {
      errorCallback(xhr.responseText);
    }
  };
  xhr.send(encodeURI(data));
}

if (commentForm) {
  commentForm.addEventListener('submit', (e) => {
    e.preventDefault();
    errorMessagesDiv.innerHTML = '';
    sendFailedDiv.style.display = 'none';
    sendSucceededDiv.style.display = 'none';

    const slug = slugInput.value.trim();
    const optionsSlug = optionsSlugInput.value.trim();
    const name = nameInput.value.trim();
    const email = emailInput.value.trim();
    const message = messageInput.value.trim();
    const spKey = '__s_p__';
    const sp = localStorage.getItem(spKey);

    let error = false;
    const messages = [];
    const spamFilter = ['bully', 'bullies', 'bullying', 'abuser'];

    if (slug === '' || slug !== optionsSlug !== '') {
      return false;
    }

    if (name.length < 1) {
      error = true;
      messages.push('Please enter name');
    }

    if (email.search(/^[a-zA-Z0-9.!#$%&’*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/) === -1) {
      error = true;
      messages.push('Please enter valid email');
    }

    if (message.length < 1) {
      error = true;
      messages.push('Please enter message');
    }

    if (error) {
      errorMessagesDiv.innerHTML = messages.join('<br>');
      return false;
    }

    for (let i = 0; i < spamFilter.length; i++) {
      const spamWord = spamFilter[i];
      if (
        sp ||
        name.toLowerCase().indexOf(spamWord) >= 0 ||
        email.toLowerCase().indexOf(spamWord) >= 0 ||
        message.toLowerCase().indexOf(spamWord) >= 0
      ) {
        commentForm.reset();
        localStorage.setItem(spKey, '_');
        sendSucceededDiv.style.display = 'block';
        return false;
      }
    }

    const params = [];

    for (let i = 0; i < commentFormInputs.length; i++) {
      const input = commentFormInputs[i];
      params.push(`${ input.name }=${ input.value }`);
    }

    post(
      e.target.getAttribute('data-action'),
      params.join('&'),
      function(text){
        commentForm.reset();
        sendSucceededDiv.style.display = 'block';
      },
      function(text){
        sendFailedDiv.style.display = 'block';
      }
    );
  });
}
</script>
<!-- /======================== -->
<!-- /Not working code, to fix -->
<!-- /======================== -->